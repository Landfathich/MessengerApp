<!DOCTYPE html>
<html>
<head>
    <title>Chat with {% if other_user %}{{ other_user.username }}{% else %}Group{% endif %}</title>
</head>
<body>
<h1>Chat with {% if other_user %}{{ other_user.username }}{% else %}Group{% endif %}</h1>

<div style="border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px;" id="chatMessages">
    <!-- ПОКАЗЫВАЕМ ИСТОРИЮ СООБЩЕНИЙ -->
    {% for message in messages %}
        <p><strong>{{ message.sender.username }}:</strong> {{ message.content }}</p>
    {% empty %}
        <p><em>No messages yet. Start the conversation!</em></p>
    {% endfor %}
</div>

<div style="margin-top: 10px;">
    <input type="text" id="messageInput" placeholder="Type your message..." style="width: 70%; padding: 5px;">
    <button onclick="sendMessage()" style="padding: 5px 10px;">Send</button>
</div>

<div style="margin-top: 20px;">
    <a href="{% url 'chat_dashboard' %}">← Back to Dashboard</a>
</div>
<script>
    const conversationId = {{ conversation.id }};
    const socket = new WebSocket('ws://' + window.location.host + '/ws/chat/' + conversationId + '/');

    socket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        addMessageToChat(data.message);
    };

    function addMessageToChat(messageText) {
        const chatDiv = document.getElementById('chatMessages');
        chatDiv.innerHTML += `<p>${messageText}</p>`;
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value;
        if (message) {
            socket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    }

    document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>